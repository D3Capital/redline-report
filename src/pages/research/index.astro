---
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const title = "Research";

// 拉取 research 集合
const posts = await getCollection("research");

// 统一排序：先 Published，再 Upcoming，再 Archived；每组按日期倒序
const statusRank = (s: string) =>
  s === "published" ? 0 : s === "upcoming" ? 1 : s === "archived" ? 2 : 9;

const safeDate = (d: any) => {
  try {
    return d ? new Date(d) : null;
  } catch {
    return null;
  }
};

const sorted = posts
  .map((p) => {
    const data: any = p.data ?? {};
    return {
      slug: p.slug,
      title: data.title ?? p.slug,
      summary: data.summary ?? data.description ?? "",
      status: (data.status ?? "published").toLowerCase(),
      date: safeDate(data.date ?? data.publishedAt ?? data.updatedAt),
    };
  })
  .sort((a, b) => {
    const sr = statusRank(a.status) - statusRank(b.status);
    if (sr !== 0) return sr;
    const ad = a.date ? a.date.getTime() : 0;
    const bd = b.date ? b.date.getTime() : 0;
    return bd - ad;
  });

const published = sorted.filter((p) => p.status === "published");
const upcoming = sorted.filter((p) => p.status === "upcoming");
const archived = sorted.filter((p) => p.status === "archived");

const fmt = (d: Date | null) =>
  d
    ? d.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "2-digit" })
    : "—";
---

<Layout title={title}>
  <header class="head">
    <div class="kicker">RESEARCH LIBRARY</div>
    <h1 class="h1">Research</h1>
    <p class="sub">
      Evidence-first, adversarial research on governance failure, disclosure distortion, and incentive misalignment.
      No narratives. No marketing. Just primary documents.
    </p>

    <div class="chips">
      <span class="chip">{published.length} Published</span>
      <span class="chip">{upcoming.length} Upcoming</span>
      <span class="chip">{archived.length} Archived</span>
    </div>
  </header>

  <!-- 三块入口：让“像系统” -->
  <section class="grid">
    <div class="card">
      <div class="label">LATEST</div>
      {published.length > 0 ? (
        <>
          <div class="title">{published[0].title}</div>
          <div class="meta">{fmt(published[0].date)} · Published</div>
          {published[0].summary && <p class="desc">{published[0].summary}</p>}
          <a class="cta" href={`/research/${published[0].slug}`}>Open report →</a>
        </>
      ) : (
        <>
          <div class="title">No published reports yet</div>
          <div class="meta">Library is live. Publishing pipeline is ready.</div>
          <p class="desc">
            Add a Markdown file under <code>src/content/research/</code> and it will appear here automatically.
          </p>
          <a class="cta" href="/methodology">Read methodology →</a>
        </>
      )}
    </div>

    <div class="card">
      <div class="label">WATCHLIST</div>
      <div class="title">Targets under review</div>
      <div class="meta">Pre-publication tracking</div>
      <p class="desc">
        This section is reserved for upcoming work. Items move here before they become published reports.
      </p>
      {upcoming.length > 0 ? (
        <ul class="list">
          {upcoming.slice(0, 3).map((p) => (
            <li>
              <a href={`/research/${p.slug}`}>{p.title}</a>
              <span class="tag">Upcoming</span>
            </li>
          ))}
        </ul>
      ) : (
        <p class="muted">No items in review yet.</p>
      )}
    </div>

    <div class="card">
      <div class="label">OPERATING STANDARD</div>
      <div class="title">Evidence standards</div>
      <div class="meta">What qualifies as publishable</div>
      <p class="desc">
        Primary sources, explicit fact/interpretation split, and corrections with versioning.
      </p>
      <a class="cta" href="/methodology">Methodology →</a>
      <a class="cta secondary" href="/disclosures">Disclosures →</a>
    </div>
  </section>

  <!-- 研究索引：像“库” -->
  <section class="index">
    <div class="index-head">
      <h2 class="h2">Research Index</h2>
      <div class="hint">Sorted by status, then by date.</div>
    </div>

    {sorted.length > 0 ? (
      <div class="table">
        <div class="row headrow">
          <div>Date</div>
          <div>Report</div>
          <div>Status</div>
        </div>

        {sorted.map((p) => (
          <a class="row" href={`/research/${p.slug}`}>
            <div class="date">{fmt(p.date)}</div>
            <div class="rtitle">
              <div class="rt">{p.title}</div>
              {p.summary && <div class="rs">{p.summary}</div>}
            </div>
            <div class="status">
              <span class={`pill ${p.status}`}>{p.status}</span>
            </div>
          </a>
        ))}
      </div>
    ) : (
      <div class="empty">
        <div class="empty-title">Library initialized. No reports published yet.</div>
        <div class="empty-sub">
          Create <code>src/content/research/your-report.md</code> with frontmatter:
          <code class="codeblock">
            {`title, date, status, summary`}
          </code>
        </div>
      </div>
    )}
  </section>
</Layout>

<style>
  .head { max-width: 960px; margin: 0 auto; padding: 44px 16px 18px; }
  .kicker { font-size: 11px; letter-spacing: .14em; color: #6b7280; font-weight: 700; }
  .h1 { font-size: 40px; margin: 8px 0 10px; color: #111827; }
  .sub { max-width: 72ch; color: #374151; margin: 0; line-height: 1.6; }

  .chips { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 14px; }
  .chip { font-size: 12px; color: #111827; background: #f3f4f6; border: 1px solid #e5e7eb; padding: 6px 10px; border-radius: 999px; }

  .grid { max-width: 960px; margin: 0 auto; padding: 16px; display: grid; gap: 14px; grid-template-columns: repeat(3, 1fr); }
  @media (max-width: 900px) { .grid { grid-template-columns: 1fr; } }

  .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; background: #fff; }
  .label { font-size: 11px; letter-spacing: .14em; color: #6b7280; font-weight: 800; margin-bottom: 8px; }
  .title { font-size: 16px; font-weight: 800; color: #111827; margin-bottom: 6px; }
  .meta { font-size: 12px; color: #6b7280; margin-bottom: 10px; }
  .desc { color: #374151; margin: 0 0 10px; line-height: 1.6; }
  .muted { color: #6b7280; margin: 0; }

  .cta { display: inline-block; margin-top: 6px; color: #111827; font-weight: 700; text-decoration: none; }
  .cta.secondary { display: inline-block; margin-left: 12px; color: #374151; font-weight: 700; text-decoration: none; }

  .list { margin: 10px 0 0; padding-left: 18px; color: #111827; }
  .list li { margin: 6px 0; }
  .list a { color: #111827; text-decoration: none; font-weight: 700; }
  .tag { font-size: 11px; margin-left: 8px; padding: 2px 8px; border-radius: 999px; border: 1px solid #e5e7eb; color: #6b7280; }

  .index { max-width: 960px; margin: 0 auto; padding: 16px 16px 48px; }
  .index-head { display: flex; justify-content: space-between; align-items: baseline; gap: 12px; margin: 10px 0 10px; }
  .h2 { margin: 0; font-size: 16px; color: #111827; }
  .hint { font-size: 12px; color: #6b7280; }

  .table { border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden; background: #fff; }
  .row { display: grid; grid-template-columns: 140px 1fr 120px; gap: 12px; padding: 12px 14px; border-top: 1px solid #e5e7eb; text-decoration: none; }
  .headrow { background: #f9fafb; border-top: none; font-size: 12px; color: #6b7280; font-weight: 800; letter-spacing: .04em; }
  .row:hover { background: #fcfcfd; }
  .date { font-size: 12px; color: #6b7280; }
  .rtitle .rt { font-weight: 800; color: #111827; }
  .rtitle .rs { font-size: 12px; color: #6b7280; margin-top: 2px; line-height: 1.45; }

  .pill { font-size: 11px; font-weight: 800; padding: 4px 10px; border-radius: 999px; border: 1px solid #e5e7eb; display: inline-block; text-transform: capitalize; }
  .pill.published { color: #111827; background: #f3f4f6; }
  .pill.upcoming { color: #111827; background: #fff7ed; border-color: #fed7aa; }
  .pill.archived { color: #6b7280; background: #f9fafb; }

  .empty { border: 1px dashed #d1d5db; border-radius: 12px; padding: 18px; background: #fff; }
  .empty-title { font-weight: 900; color: #111827; margin-bottom: 8px; }
  .empty-sub { color: #374151; font-size: 13px; line-height: 1.6; }
  .codeblock { display: inline-block; margin-left: 8px; padding: 2px 8px; border-radius: 8px; background: #f3f4f6; border: 1px solid #e5e7eb; font-size: 12px; }
  code { background: #f3f4f6; border: 1px solid #e5e7eb; border-radius: 6px; padding: 1px 6px; font-size: 12px; }
</style>